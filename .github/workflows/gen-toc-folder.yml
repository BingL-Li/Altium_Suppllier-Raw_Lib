name: Generate Enhanced Folder TOC
on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  generate-folder-toc:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate Enhanced Folder Structure
        run: |
          cat > generate_toc.py << 'EOF'
          import os
          import glob
          
          def count_files_by_type(directory):
              """Count Altium library files by type"""
              counts = {
                  'intlib': 0,    # Integrated Libraries
                  'pcblib': 0,    # Footprint Libraries  
                  'schlib': 0,    # Symbol Libraries
                  'pdf': 0        # Datasheets
              }
              
              # Count files in current directory and subdirectories
              for root, dirs, files in os.walk(directory):
                  for file in files:
                      file_lower = file.lower()
                      if file_lower.endswith('.intlib'):
                          counts['intlib'] += 1
                      elif file_lower.endswith('.pcblib'):
                          counts['pcblib'] += 1
                      elif file_lower.endswith('.schlib'):
                          counts['schlib'] += 1
                      elif file_lower.endswith('.pdf'):
                          counts['pdf'] += 1
              
              return counts
          
          def get_all_files_by_type():
              """Get all files organized by type and folder"""
              files_by_type = {
                  'intlib': {},    # folder: [files]
                  'schlib': {},
                  'pcblib': {},
                  'pdf': {}
              }
              
              for root, dirs, files in os.walk('.'):
                  # Skip .git and .github directories
                  dirs[:] = [d for d in dirs if not d.startswith('.git')]
                  
                  if root == '.':
                      continue
                  
                  folder_name = os.path.basename(root)
                  relative_path = root
                  
                  for file in files:
                      file_lower = file.lower()
                      if file_lower.endswith('.intlib'):
                          if relative_path not in files_by_type['intlib']:
                              files_by_type['intlib'][relative_path] = []
                          files_by_type['intlib'][relative_path].append(file)
                      elif file_lower.endswith('.schlib'):
                          if relative_path not in files_by_type['schlib']:
                              files_by_type['schlib'][relative_path] = []
                          files_by_type['schlib'][relative_path].append(file)
                      elif file_lower.endswith('.pcblib'):
                          if relative_path not in files_by_type['pcblib']:
                              files_by_type['pcblib'][relative_path] = []
                          files_by_type['pcblib'][relative_path].append(file)
                      elif file_lower.endswith('.pdf'):
                          if relative_path not in files_by_type['pdf']:
                              files_by_type['pdf'][relative_path] = []
                          files_by_type['pdf'][relative_path].append(file)
              
              return files_by_type
          
          def generate_folder_toc():
              toc = ["## 📁 Repository Structure\n\n"]
              
              # First, generate overall statistics
              total_counts = count_files_by_type('.')
              if any(total_counts.values()):
                  toc.append("### 📊 Library Summary\n")
                  if total_counts['intlib'] > 0:
                      toc.append(f"- 🔗 **{total_counts['intlib']}** Integrated Libraries (*.IntLib)\n")
                  if total_counts['schlib'] > 0:
                      toc.append(f"- 📐 **{total_counts['schlib']}** Symbol Libraries (*.SchLib)\n")
                  if total_counts['pcblib'] > 0:
                      toc.append(f"- 🦶 **{total_counts['pcblib']}** Footprint Libraries (*.PcbLib)\n")
                  if total_counts['pdf'] > 0:
                      toc.append(f"- 📄 **{total_counts['pdf']}** Datasheets (*.pdf)\n")
                  toc.append("\n")
              
              # Then generate folder structure
              toc.append("### 📂 Folder Structure\n\n")
              
              # Get all directories
              directories = []
              for root, dirs, files in os.walk('.'):
                  # Skip .git and .github directories
                  dirs[:] = [d for d in dirs if not d.startswith('.git')]
                  
                  if root != '.':
                      directories.append(root)
              
              directories.sort()
              
              for directory in directories:
                  level = directory.count(os.sep) - 1
                  indent = '  ' * level
                  folder_name = os.path.basename(directory)
                  
                  # Count files in this specific directory (not subdirectories)
                  counts = {
                      'intlib': len([f for f in os.listdir(directory) if f.lower().endswith('.intlib') and os.path.isfile(os.path.join(directory, f))]),
                      'schlib': len([f for f in os.listdir(directory) if f.lower().endswith('.schlib') and os.path.isfile(os.path.join(directory, f))]),
                      'pcblib': len([f for f in os.listdir(directory) if f.lower().endswith('.pcblib') and os.path.isfile(os.path.join(directory, f))]),
                      'pdf': len([f for f in os.listdir(directory) if f.lower().endswith('.pdf') and os.path.isfile(os.path.join(directory, f))])
                  }
                  
                  # Create description based on file types
                  descriptions = []
                  if counts['intlib'] > 0:
                      descriptions.append(f"🔗 {counts['intlib']} IntLib")
                  if counts['schlib'] > 0:
                      descriptions.append(f"📐 {counts['schlib']} SchLib")
                  if counts['pcblib'] > 0:
                      descriptions.append(f"🦶 {counts['pcblib']} PcbLib")
                  if counts['pdf'] > 0:
                      descriptions.append(f"📄 {counts['pdf']} PDF")
                  
                  if descriptions:
                      desc = " | ".join(descriptions)
                      toc.append(f"{indent}- [📂 **{folder_name}**]({directory}/) - *{desc}*\n")
                  else:
                      toc.append(f"{indent}- [📂 {folder_name}]({directory}/)\n")
              
              # Add detailed file listings organized by type, then by folder
              toc.append("\n### 📋 Detailed File Listings\n\n")
              
              files_by_type = get_all_files_by_type()
              
              # Integrated Libraries
              if files_by_type['intlib']:
                  toc.append("#### 🔗 Integrated Libraries (*.IntLib)\n\n")
                  for folder_path in sorted(files_by_type['intlib'].keys()):
                      folder_name = os.path.basename(folder_path)
                      toc.append(f"**📂 {folder_name}:**\n")
                      for file in sorted(files_by_type['intlib'][folder_path]):
                          toc.append(f"- [{file}]({folder_path}/{file})\n")
                      toc.append("\n")
              
              # Symbol Libraries
              if files_by_type['schlib']:
                  toc.append("#### 📐 Symbol Libraries (*.SchLib)\n\n")
                  for folder_path in sorted(files_by_type['schlib'].keys()):
                      folder_name = os.path.basename(folder_path)
                      toc.append(f"**📂 {folder_name}:**\n")
                      for file in sorted(files_by_type['schlib'][folder_path]):
                          toc.append(f"- [{file}]({folder_path}/{file})\n")
                      toc.append("\n")
              
              # Footprint Libraries
              if files_by_type['pcblib']:
                  toc.append("#### 🦶 Footprint Libraries (*.PcbLib)\n\n")
                  for folder_path in sorted(files_by_type['pcblib'].keys()):
                      folder_name = os.path.basename(folder_path)
                      toc.append(f"**📂 {folder_name}:**\n")
                      for file in sorted(files_by_type['pcblib'][folder_path]):
                          toc.append(f"- [{file}]({folder_path}/{file})\n")
                      toc.append("\n")
              
              # Datasheets
              if files_by_type['pdf']:
                  toc.append("#### 📄 Datasheets (*.pdf)\n\n")
                  for folder_path in sorted(files_by_type['pdf'].keys()):
                      folder_name = os.path.basename(folder_path)
                      toc.append(f"**📂 {folder_name}:**\n")
                      for file in sorted(files_by_type['pdf'][folder_path]):
                          toc.append(f"- [{file}]({folder_path}/{file})\n")
                      toc.append("\n")
              
              return ''.join(toc)
          
          # Generate and save TOC
          with open('folder_toc.md', 'w') as f:
              f.write(generate_folder_toc())
          EOF
          
          python generate_toc.py

      - name: Update README
        run: |
          if grep -q "<!-- FOLDER-TOC -->" README.md; then
            # Create temporary file with new content
            awk '
            /<!-- FOLDER-TOC -->/ {print; system("cat folder_toc.md"); f=1; next}
            /<!-- \/FOLDER-TOC -->/ {f=0}
            !f {print}
            ' README.md > temp_readme.md
            mv temp_readme.md README.md
          else
            # If no markers exist, append to end
            echo "" >> README.md
            echo "<!-- FOLDER-TOC -->" >> README.md
            cat folder_toc.md >> README.md
            echo "<!-- /FOLDER-TOC -->" >> README.md
          fi

      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git diff --staged --quiet || git commit -m "docs: update Altium library structure organized by file type"
          git push