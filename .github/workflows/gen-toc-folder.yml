name: Generate Enhanced Folder TOC
on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  generate-folder-toc:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate Enhanced Folder Structure
        run: |
          cat > generate_toc.py << 'EOF'
          import os
          import urllib.parse
          
          def url_encode_path(path):
              """URL encode path for GitHub links"""
              # Split path into parts and encode each part
              parts = path.split('/')
              encoded_parts = [urllib.parse.quote(part) for part in parts]
              return '/'.join(encoded_parts)
          
          def count_files_by_type(directory):
              """Count Altium library files by type"""
              counts = {
                  'intlib': 0,    # Integrated Libraries
                  'pcblib': 0,    # Footprint Libraries  
                  'schlib': 0,    # Symbol Libraries
                  'step': 0,      # 3D Models (STP/STEP)
                  'pdf': 0        # Datasheets
              }
              
              # Count files in current directory and subdirectories
              for root, dirs, files in os.walk('.'):
                  for file in files:
                      file_lower = file.lower()
                      if file_lower.endswith('.intlib'):
                          counts['intlib'] += 1
                      elif file_lower.endswith('.pcblib'):
                          counts['pcblib'] += 1
                      elif file_lower.endswith('.schlib'):
                          counts['schlib'] += 1
                      elif file_lower.endswith(('.stp', '.step')):
                          counts['step'] += 1
                      elif file_lower.endswith('.pdf'):
                          counts['pdf'] += 1
              
              return counts
          
          def get_all_files_by_type():
              """Get all files organized by type and folder with hierarchy info"""
              files_by_type = {
                  'intlib': {},    # folder: {'files': [files], 'level': depth}
                  'schlib': {},
                  'pcblib': {},
                  'step': {},      # 3D Models
                  'pdf': {}
              }
              
              for root, dirs, files in os.walk('.'):
                  # Skip .git and .github directories
                  dirs[:] = [d for d in dirs if not d.startswith('.git')]
                  
                  if root == '.':
                      continue
                  
                  # Calculate folder depth for proper indentation
                  folder_depth = root.count(os.sep)
                  relative_path = root
                  
                  for file in files:
                      file_lower = file.lower()
                      if file_lower.endswith('.intlib'):
                          if relative_path not in files_by_type['intlib']:
                              files_by_type['intlib'][relative_path] = {'files': [], 'level': folder_depth}
                          files_by_type['intlib'][relative_path]['files'].append(file)
                      elif file_lower.endswith('.schlib'):
                          if relative_path not in files_by_type['schlib']:
                              files_by_type['schlib'][relative_path] = {'files': [], 'level': folder_depth}
                          files_by_type['schlib'][relative_path]['files'].append(file)
                      elif file_lower.endswith('.pcblib'):
                          if relative_path not in files_by_type['pcblib']:
                              files_by_type['pcblib'][relative_path] = {'files': [], 'level': folder_depth}
                          files_by_type['pcblib'][relative_path]['files'].append(file)
                      elif file_lower.endswith(('.stp', '.step')):
                          if relative_path not in files_by_type['step']:
                              files_by_type['step'][relative_path] = {'files': [], 'level': folder_depth}
                          files_by_type['step'][relative_path]['files'].append(file)
                      elif file_lower.endswith('.pdf'):
                          if relative_path not in files_by_type['pdf']:
                              files_by_type['pdf'][relative_path] = {'files': [], 'level': folder_depth}
                          files_by_type['pdf'][relative_path]['files'].append(file)
              
              return files_by_type
          
          def generate_folder_toc():
              toc = []  # Start with empty list, no main header
              
              # First, generate overall statistics
              total_counts = count_files_by_type('.')
              if any(total_counts.values()):
                  toc.append("## 📊 Library Summary\n")
                  if total_counts['intlib'] > 0:
                      toc.append(f"- 🔗 **{total_counts['intlib']}** Integrated Libraries (*.IntLib)\n")
                  if total_counts['schlib'] > 0:
                      toc.append(f"- 📐 **{total_counts['schlib']}** Symbol Libraries (*.SchLib)\n")
                  if total_counts['pcblib'] > 0:
                      toc.append(f"- 🦶 **{total_counts['pcblib']}** Footprint Libraries (*.PcbLib)\n")
                  if total_counts['step'] > 0:
                      toc.append(f"- 🎯 **{total_counts['step']}** 3D Models (*.STP/*.STEP)\n")
                  if total_counts['pdf'] > 0:
                      toc.append(f"- 📄 **{total_counts['pdf']}** Datasheets (*.pdf)\n")
                  toc.append("\n")
              
              # Then generate folder structure
              toc.append("## 📂 Folder Structure\n\n")
              
              # Get all directories
              directories = []
              for root, dirs, files in os.walk('.'):
                  # Skip .git and .github directories
                  dirs[:] = [d for d in dirs if not d.startswith('.git')]
                  
                  if root != '.':
                      directories.append(root)
              
              directories.sort()
              
              for directory in directories:
                  level = directory.count(os.sep) - 1
                  indent = '  ' * level
                  folder_name = os.path.basename(directory)
                  encoded_directory = url_encode_path(directory)
                  
                  # Count files in this specific directory (not subdirectories)
                  counts = {
                      'intlib': len([f for f in os.listdir(directory) if f.lower().endswith('.intlib') and os.path.isfile(os.path.join(directory, f))]),
                      'schlib': len([f for f in os.listdir(directory) if f.lower().endswith('.schlib') and os.path.isfile(os.path.join(directory, f))]),
                      'pcblib': len([f for f in os.listdir(directory) if f.lower().endswith('.pcblib') and os.path.isfile(os.path.join(directory, f))]),
                      'step': len([f for f in os.listdir(directory) if f.lower().endswith(('.stp', '.step')) and os.path.isfile(os.path.join(directory, f))]),
                      'pdf': len([f for f in os.listdir(directory) if f.lower().endswith('.pdf') and os.path.isfile(os.path.join(directory, f))])
                  }
                  
                  # Create description based on file types
                  descriptions = []
                  if counts['intlib'] > 0:
                      descriptions.append(f"🔗 {counts['intlib']} IntLib")
                  if counts['schlib'] > 0:
                      descriptions.append(f"📐 {counts['schlib']} SchLib")
                  if counts['pcblib'] > 0:
                      descriptions.append(f"🦶 {counts['pcblib']} PcbLib")
                  if counts['step'] > 0:
                      descriptions.append(f"🎯 {counts['step']} 3D")
                  if counts['pdf'] > 0:
                      descriptions.append(f"📄 {counts['pdf']} PDF")
                  
                  if descriptions:
                      desc = " | ".join(descriptions)
                      toc.append(f"{indent}- [📂 **{folder_name}**]({encoded_directory}/) - *{desc}*\n")
                  else:
                      toc.append(f"{indent}- [📂 {folder_name}]({encoded_directory}/)\n")
              
              # Add detailed file listings organized by type, then by folder
              toc.append("\n## 📋 Detailed File Listings\n\n")
              
              files_by_type = get_all_files_by_type()
              
              # File type configurations with their display info - REORDERED
              file_types = [
                  ('pdf', '📄', 'Datasheets', '*.pdf'),                    # 1st - Datasheets
                  ('schlib', '📐', 'Symbol Libraries', '*.SchLib'),        # 2nd - Symbol Libraries
                  ('pcblib', '🦶', 'Footprint Libraries', '*.PcbLib'),     # 3rd - Footprint Libraries
                  ('step', '🎯', '3D Models', '*.STP/*.STEP'),             # 4th - 3D Models
                  ('intlib', '🔗', 'Integrated Libraries', '*.IntLib'),    # 5th - Integrated Libraries
              ]
              
              for file_type, emoji, display_name, extension in file_types:
                  if files_by_type[file_type]:
                      # File type header (level 3: ###)
                      toc.append(f"### {emoji} {display_name} ({extension})\n\n")
                      
                      # Sort folders by path for consistent ordering
                      sorted_folders = sorted(files_by_type[file_type].keys())
                      
                      for folder_path in sorted_folders:
                          folder_info = files_by_type[file_type][folder_path]
                          folder_name = os.path.basename(folder_path)
                          
                          # All folder headers are level 4 (####) regardless of depth
                          toc.append(f"#### 📂 {folder_name}\n\n")
                          
                          # Use consistent 2-space indentation for all file lists
                          indent = "  "  # Always 2 spaces to avoid code block formatting
                          
                          for file in sorted(folder_info['files']):
                              encoded_path = url_encode_path(f"{folder_path}/{file}")
                              
                              # Special handling for 3D models (show file size)
                              if file_type == 'step':
                                  try:
                                      file_size = os.path.getsize(f"{folder_path}/{file}")
                                      if file_size > 1024*1024:  # > 1MB
                                          size_str = f" *({file_size/(1024*1024):.1f} MB)*"
                                      elif file_size > 1024:  # > 1KB
                                          size_str = f" *({file_size/1024:.1f} KB)*"
                                      else:
                                          size_str = f" *({file_size} B)*"
                                  except:
                                      size_str = ""
                                  toc.append(f"{indent}- [{file}]({encoded_path}){size_str}\n")
                              else:
                                  toc.append(f"{indent}- [{file}]({encoded_path})\n")
                          
                          toc.append("\n")  # Add spacing between folders
              
              return ''.join(toc)
          
          # Generate and save TOC
          with open('folder_toc.md', 'w') as f:
              f.write(generate_folder_toc())
          EOF
          
          python generate_toc.py

      - name: Update README
        run: |
          if grep -q "<!-- FOLDER-TOC -->" README.md; then
            # Create temporary file with new content
            awk '
            /<!-- FOLDER-TOC -->/ {print; system("cat folder_toc.md"); f=1; next}
            /<!-- \/FOLDER-TOC -->/ {f=0}
            !f {print}
            ' README.md > temp_readme.md
            mv temp_readme.md README.md
          else
            # If no markers exist, append to end
            echo "" >> README.md
            echo "<!-- FOLDER-TOC -->" >> README.md
            cat folder_toc.md >> README.md
            echo "<!-- /FOLDER-TOC -->" >> README.md
          fi

      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git diff --staged --quiet || git commit -m "docs: reorder detailed sections - datasheets first"
          git push